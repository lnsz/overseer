#!/bin/sh

set -e

tag='latest'
if [ "$CI_COMMIT_REF_NAME" ]  && [ "$CI_COMMIT_REF_NAME" != 'master' ]; then
  tag="$CI_COMMIT_REF_NAME"
fi

rm tmp/pids/server.pid
echo "Building overseer:$tag"
docker build \
  --tag "overseer:$tag" \
  --file "./docker/Dockerfile" \
  "./"

if [ "$REGISTRY" ]; then
  echo "Pushing to $REGISTRY/overseer:$tag"
  docker tag "overseer:$tag" "$REGISTRY/overseer:$tag"
  docker push "$REGISTRY/overseer:$tag"
  docker image rm "$REGISTRY/overseer:$tag"
fi